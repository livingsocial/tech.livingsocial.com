---
layout: post
title: Permanent Link to ActsAsInsertOrUpdate
author: aaron
---
      
					<h2>Problem</h2>
<p>
With high volume Rails applications, entities with unique constraints are expensive and error prone to create/update. ActsAsInsertOrUpdate helps solve that problem (if you’re using MySQL), by leveraging the “INSERT … ON DUPLICATE KEY UPDATE” functionality.
</p>
<h2>Scenario</h2>
<p> Lets say you have a Person, and Entity, and a Rating. Each user can rate each entity only once, and if they re-rate the entity, it should update the value.</p>
<div class="CodeRay">
<div class="code">
<pre><span style="color:#080; font-weight:bold">class</span> <span style="color:#B06; font-weight:bold">Entity</span> &lt; <span style="color:#036; font-weight:bold">ActiveRecord</span>::<span style="color:#036; font-weight:bold">Base</span>
  has_many <span style="color:#A60">:ratings</span>
<span style="color:#080; font-weight:bold">end</span>

<span style="color:#080; font-weight:bold">class</span> <span style="color:#B06; font-weight:bold">Person</span> &lt; <span style="color:#036; font-weight:bold">ActiveRecord</span>::<span style="color:#036; font-weight:bold">Base</span>
 has_many <span style="color:#A60">:ratings</span>
<span style="color:#080; font-weight:bold">end</span>

<span style="color:#080; font-weight:bold">class</span> <span style="color:#B06; font-weight:bold">Rating</span> &lt; <span style="color:#036; font-weight:bold">ActiveRecord</span>::<span style="color:#036; font-weight:bold">Base</span>
 belongs_to <span style="color:#A60"> <img src="http://blog.hungrymachine.com/wp-includes/images/smilies/icon_razz.gif" alt=":P" class="wp-smiley"> erson</span>
 belongs_to <span style="color:#A60">:Entity</span>
<span style="color:#080; font-weight:bold">end</span>  </pre>
</div>
</div>
<p>Here is the table that back’s Rating. Notice the Unique Key constraint on (entity_id, person_id).</p>
<div class="CodeRay">
<div class="code">
<pre>CREATE TABLE `ratings` (
  `id` int(11) NOT NULL auto_increment,
  `rating` tinyint(4) default '0',
  `person_id` int(11) default NULL,
  `entity_id` int(11) default NULL,
  `created_at` datetime default NULL,
  `updated_at` datetime default NULL,
  PRIMARY KEY  (`id`),
  UNIQUE KEY `index_ratings_on_entity_id_and_person_id` (`entity_id`,`person_id`),
)</pre>
</div>
</div>
<p>Previously, the logic would be something like:</p>
<ul>
<li>1) Check if a rating exists for the User + Entity</li>
<li>2) If so, update</li>
<li>3) If not, insert</li>
<li>4) rescue the insert in case there is a unqiue constraint error</li>
<li>5) retrieve the record (and/or update with the new rating)</li>
<p>
If the table is MyISAM, Steps 1-5 aren’t transactionally safe.  If you’re using InnoDB, and experience heavy volumes of traffic, you’re prone to Deadlock’s.  This is even more of a concern is the unique entity is shared across multiple users, as seen with a recent client of ours.
</p>
<h2>Solution:</h2>
<div class="CodeRay">
<div class="code">
<pre><span style="color:#080; font-weight:bold">class</span> <span style="color:#B06; font-weight:bold">Rating</span> &lt; <span style="color:#036; font-weight:bold">ActiveRecord</span>::<span style="color:#036; font-weight:bold">Base</span>
 belongs_to <span style="color:#A60"> <img src="http://blog.hungrymachine.com/wp-includes/images/smilies/icon_razz.gif" alt=":P" class="wp-smiley"> erson</span>
 belongs_to <span style="color:#A60">:Entity</span>
 acts_as_insert_or_update <span style="color:#A60">:field_to_update</span> =&gt; <span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">rating</span><span style="color:#710">"</span></span>
<span style="color:#080; font-weight:bold">end</span>  </pre>
</div>
</div>
<p>Now Steps 1-5 above become, just one.  Rating.create(..)</p>
<p>In the background, ActsAsInsertOrUpdate overwrites the implementation of ActionRecord:Base#create, to leverage an often unsed feature of MySQL called INSERT … ON DUPLICATE KEY UPDATE. As configured above, if a duplicate record is found for the unique constraint, the rating field will be updated with the new value. </p>
<h2>Caution</h2>
<p>This is a brute force hack on ActiveRecord::Base#create.  Use at your own risk.</p>
<h2>Code</h2>
<p>Waiting for a rubyforge account.  Will post more info soon.</p>
				</ul>