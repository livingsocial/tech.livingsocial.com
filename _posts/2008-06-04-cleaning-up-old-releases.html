---
layout: post
title: Permanent Link to Cleaning up old releases
author: val
---
      
					<p>Instead of relaying on running cleanup of old releases via capistrano, we have a cron job to only keep releases for last two days (but at least three latest).</p>
<div class="CodeRay">
<div class="code">
<pre><span style="color:#888">#!/usr/bin/env ruby</span>

require <span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">fileutils</span><span style="color:#710">'</span></span>

<span style="color:#036; font-weight:bold">KEEP_RELEASES</span> = <span style="color:#00D; font-weight:bold">3</span>
<span style="color:#036; font-weight:bold">KEEP_DAYS</span> = <span style="color:#00D; font-weight:bold">2</span>
<span style="color:#036; font-weight:bold">EXCLUDE_APPS</span> = <span style="background-color:#fff0f0"><span style="color:#710">%W(</span><span style="color:#D20">uploadr</span><span style="color:#710">)</span></span>

cut_time = (<span style="color:#036; font-weight:bold">Time</span>.now.utc - <span style="color:#036; font-weight:bold">KEEP_DAYS</span>*<span style="color:#00D; font-weight:bold">24</span>*<span style="color:#00D; font-weight:bold">60</span>*<span style="color:#00D; font-weight:bold">60</span>).strftime(<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">%Y%m%d%H%M%S</span><span style="color:#710">"</span></span>).to_i

<span style="color:#036; font-weight:bold">Dir</span>[<span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">/u/apps/*</span><span style="color:#710">'</span></span>].each <span style="color:#080; font-weight:bold">do</span> |app|
  <span style="color:#080; font-weight:bold">next</span> <span style="color:#080; font-weight:bold">if</span> <span style="color:#036; font-weight:bold">EXCLUDE_APPS</span>.include?(<span style="color:#036; font-weight:bold">File</span>.basename(app))
  dirs = <span style="color:#036; font-weight:bold">Dir</span>[<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="background-color:#fff0f0"><span style="color:#710">#{</span> app <span style="color:#710">}</span></span><span style="color:#D20">/releases/*</span><span style="color:#710">"</span></span>]
  fresh = dirs.select { |dir| (dir.split(<span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>).last).to_i &gt; cut_time }
  latest = dirs.sort.last(<span style="color:#036; font-weight:bold">KEEP_RELEASES</span> )

  (dirs - fresh - latest).each <span style="color:#080; font-weight:bold">do</span> |dir|
    <span style="color:#036; font-weight:bold">FileUtils</span>.rm_rf dir
  <span style="color:#080; font-weight:bold">end</span>
<span style="color:#080; font-weight:bold">end</span></pre>
</div>
</div>
				