---
layout: post
title: Permanent Link to Agressive Timeouts On External API Calls
author: val
---
      
					<p>One of the challenges with writing a Facebook or Bebo application is staying within a limit it gives you to respond with data before it shows the <em>Application Did Not Respond</em> page to a user. Having a content reach application calling external APIs, like Amazon or YouTube, with response times beyond your control, forces you to keep such calls short to allow extra time for processing. We usually wrap them in aggressive timeouts with a retry. As an example is this code from the <a href="http://www.pluitsolutions.com/projects/amazon-ecs">Ruby Amazon E-Commerce <span class="caps">REST</span> Service <span class="caps">API</span></a> gem rewritten to limit a single call attempt to two seconds with one more retry.</p>
<p><strong>Original Code</strong></p>
<div class="CodeRay">
<div class="code">
<pre><span style="color:#080; font-weight:bold">module</span> <span style="color:#B06; font-weight:bold">Amazon</span>
  <span style="color:#080; font-weight:bold">class</span> <span style="color:#B06; font-weight:bold">Ecs</span>

    <span style="color:#080; font-weight:bold">def</span> <span style="color:#038; font-weight:bold">self</span>.send_request(opts)
      request_url = prepare_url(opts)

      res = <span style="color:#036; font-weight:bold">Net</span>::<span style="color:#036; font-weight:bold">HTTP</span>.get_response(<span style="color:#036; font-weight:bold">URI</span>::parse(request_url))
      <span style="color:#080; font-weight:bold">unless</span> res.kind_of? <span style="color:#036; font-weight:bold">Net</span>::<span style="color:#036; font-weight:bold">HTTPSuccess</span>
        raise <span style="color:#036; font-weight:bold">Amazon</span>::<span style="color:#036; font-weight:bold">RequestError</span>, <span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">HTTP Response: </span><span style="background-color:#fff0f0"><span style="color:#710">#{</span>res.code<span style="color:#710">}</span></span><span style="color:#D20"> </span><span style="background-color:#fff0f0"><span style="color:#710">#{</span>res.message<span style="color:#710">}</span></span><span style="color:#710">"</span></span>
      <span style="color:#080; font-weight:bold">end</span>
      <span style="color:#036; font-weight:bold">Response</span>.new(res.body)
    <span style="color:#080; font-weight:bold">end</span>

  <span style="color:#080; font-weight:bold">end</span>
<span style="color:#080; font-weight:bold">end</span></pre>
</div>
</div>
<p><strong>Modified Code</strong></p>
<div class="CodeRay">
<div class="code">
<pre><span style="color:#080; font-weight:bold">module</span> <span style="color:#B06; font-weight:bold">Amazon</span>
  <span style="color:#080; font-weight:bold">class</span> <span style="color:#B06; font-weight:bold">Ecs</span>

    <span style="color:#080; font-weight:bold">class</span> <span style="color:#B06; font-weight:bold">EmptyResponse</span>
      <span style="color:#080; font-weight:bold">def</span> <span style="color:#06B; font-weight:bold">items</span>; []; <span style="color:#080; font-weight:bold">end</span>
      <span style="color:#080; font-weight:bold">def</span> <span style="color:#06B; font-weight:bold">total_pages</span>; <span style="color:#00D; font-weight:bold">0</span>; <span style="color:#080; font-weight:bold">end</span>
    <span style="color:#080; font-weight:bold">end</span>

    <span style="color:#080; font-weight:bold">def</span> <span style="color:#038; font-weight:bold">self</span>.send_request(opts)

      res = timed_try(request_url, <span style="color:#00D; font-weight:bold">2</span>) <span style="color:#080; font-weight:bold">do</span> |url|

        uri = <span style="color:#036; font-weight:bold">URI</span>::parse(url)
        req = <span style="color:#036; font-weight:bold">Net</span>::<span style="color:#036; font-weight:bold">HTTP</span>.new(uri.host, uri.port)

        <span style="color:#888"># Agressive timeouts</span>
        req.open_timeout = <span style="color:#00D; font-weight:bold">1</span>
        req.read_timeout = <span style="color:#00D; font-weight:bold">2</span>

        req.start { |http| http.request_get(url) }

      <span style="color:#080; font-weight:bold">end</span>

      res.kind_of?(<span style="color:#036; font-weight:bold">Net</span>::<span style="color:#036; font-weight:bold">HTTPSuccess</span>) ? <span style="color:#036; font-weight:bold">Response</span>.new(res.body) : <span style="color:#036; font-weight:bold">EmptyResponse</span>.new

    <span style="color:#080; font-weight:bold">end</span>

private

     <span style="color:#080; font-weight:bold">def</span> <span style="color:#06B; font-weight:bold">timed_try</span>(url, attempts, &amp;block)

       attempt = <span style="color:#00D; font-weight:bold">1</span>
       <span style="color:#080; font-weight:bold">begin</span>
         block.call(url)
       <span style="color:#080; font-weight:bold">rescue</span> <span style="color:#036; font-weight:bold">Timeout</span>::<span style="color:#036; font-weight:bold">Error</span>
         <span style="color:#080; font-weight:bold">if</span> attempt &gt;= attempts
           <span style="color:#036; font-weight:bold">RAILS_DEFAULT_LOGGER</span>.warn <span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">[amazon_api] gave up after attempt #</span><span style="background-color:#fff0f0"><span style="color:#710">#{</span> attempt <span style="color:#710">}</span></span><span style="color:#D20"> to get data from </span><span style="background-color:#fff0f0"><span style="color:#710">#{</span> url <span style="color:#710">}</span></span><span style="color:#710">"</span></span>
           <span style="color:#038; font-weight:bold">nil</span>
         <span style="color:#080; font-weight:bold">else</span>
           <span style="color:#036; font-weight:bold">RAILS_DEFAULT_LOGGER</span>.warn <span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">[amazon_api] attempt #</span><span style="background-color:#fff0f0"><span style="color:#710">#{</span> attempt <span style="color:#710">}</span></span><span style="color:#D20"> timed out on getting data from </span><span style="background-color:#fff0f0"><span style="color:#710">#{</span> url <span style="color:#710">}</span></span><span style="color:#710">"</span></span>
           attempt += <span style="color:#00D; font-weight:bold">1</span>
           <span style="color:#080; font-weight:bold">retry</span>
         <span style="color:#080; font-weight:bold">end</span>
       <span style="color:#080; font-weight:bold">end</span>

     <span style="color:#080; font-weight:bold">end</span>

  <span style="color:#080; font-weight:bold">end</span>
<span style="color:#080; font-weight:bold">end</span></pre>
</div>
</div>
				