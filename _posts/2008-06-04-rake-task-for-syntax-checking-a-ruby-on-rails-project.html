---
layout: post
title: Permanent Link to Rake task for syntax checking a Ruby on Rails project
author: warren
---
      
					<p>Here’s a quick rake file that will crawl through your Rails project and syntax check ruby, erb, and yml files.  You should always run this before doing a “cap deploy” and it even doesn’t hurt to run it before a “svn commit”.</p>
<div class="CodeRay">
<div class="code">
<pre>require <span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">erb</span><span style="color:#710">'</span></span>
require <span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">open3</span><span style="color:#710">'</span></span>
require <span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">yaml</span><span style="color:#710">'</span></span>

task <span style="color:#A60">:check_syntax</span> =&gt; [<span style="color:#A60">:check_ruby</span>, <span style="color:#A60">:check_erb</span>, <span style="color:#A60">:check_yaml</span>]

task <span style="color:#A60">:check_erb</span> <span style="color:#080; font-weight:bold">do</span>
  (<span style="color:#036; font-weight:bold">Dir</span>[<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">**/*.erb</span><span style="color:#710">"</span></span>] + <span style="color:#036; font-weight:bold">Dir</span>[<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">**/*.rhtml</span><span style="color:#710">"</span></span>]).each <span style="color:#080; font-weight:bold">do</span> |file|
    <span style="color:#080; font-weight:bold">next</span> <span style="color:#080; font-weight:bold">if</span> file.match(<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">vendor/rails</span><span style="color:#710">"</span></span>)
    <span style="color:#036; font-weight:bold">Open3</span>.popen3(<span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">ruby -c</span><span style="color:#710">'</span></span>) <span style="color:#080; font-weight:bold">do</span> |stdin, stdout, stderr|
      stdin.puts(<span style="color:#036; font-weight:bold">ERB</span>.new(<span style="color:#036; font-weight:bold">File</span>.read(file), <span style="color:#038; font-weight:bold">nil</span>, <span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">-</span><span style="color:#710">'</span></span>).src)
      stdin.close
      <span style="color:#080; font-weight:bold">if</span> error = ((stderr.readline <span style="color:#080; font-weight:bold">rescue</span> <span style="color:#038; font-weight:bold">false</span>))
        puts file + error[<span style="color:#00D; font-weight:bold">1</span>..<span style="color:#00D; font-weight:bold">-1</span>]
      <span style="color:#080; font-weight:bold">end</span>
      stdout.close <span style="color:#080; font-weight:bold">rescue</span> <span style="color:#038; font-weight:bold">false</span>
      stderr.close <span style="color:#080; font-weight:bold">rescue</span> <span style="color:#038; font-weight:bold">false</span>
    <span style="color:#080; font-weight:bold">end</span>
  <span style="color:#080; font-weight:bold">end</span>
<span style="color:#080; font-weight:bold">end</span>

task <span style="color:#A60">:check_ruby</span> <span style="color:#080; font-weight:bold">do</span>
  <span style="color:#036; font-weight:bold">Dir</span>[<span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">**/*.rb</span><span style="color:#710">'</span></span>].each <span style="color:#080; font-weight:bold">do</span> |file|
    <span style="color:#080; font-weight:bold">next</span> <span style="color:#080; font-weight:bold">if</span> file.match(<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">vendor/rails</span><span style="color:#710">"</span></span>)
    <span style="color:#080; font-weight:bold">next</span> <span style="color:#080; font-weight:bold">if</span> file.match(<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">vendor/plugins/.*/generators/.*/templates</span><span style="color:#710">"</span></span>)
    <span style="color:#036; font-weight:bold">Open3</span>.popen3(<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">ruby -c </span><span style="background-color:#fff0f0"><span style="color:#710">#{</span>file<span style="color:#710">}</span></span><span style="color:#710">"</span></span>) <span style="color:#080; font-weight:bold">do</span> |stdin, stdout, stderr|
      <span style="color:#080; font-weight:bold">if</span> error = ((stderr.readline <span style="color:#080; font-weight:bold">rescue</span> <span style="color:#038; font-weight:bold">false</span>))
        puts error
      <span style="color:#080; font-weight:bold">end</span>
      stdin.close <span style="color:#080; font-weight:bold">rescue</span> <span style="color:#038; font-weight:bold">false</span>
      stdout.close <span style="color:#080; font-weight:bold">rescue</span> <span style="color:#038; font-weight:bold">false</span>
      stderr.close <span style="color:#080; font-weight:bold">rescue</span> <span style="color:#038; font-weight:bold">false</span>
    <span style="color:#080; font-weight:bold">end</span>
  <span style="color:#080; font-weight:bold">end</span>
<span style="color:#080; font-weight:bold">end</span>

task <span style="color:#A60">:check_yaml</span> <span style="color:#080; font-weight:bold">do</span>
  <span style="color:#036; font-weight:bold">Dir</span>[<span style="background-color:#fff0f0"><span style="color:#710">'</span><span style="color:#D20">**/*.yml</span><span style="color:#710">'</span></span>].each <span style="color:#080; font-weight:bold">do</span> |file|
    <span style="color:#080; font-weight:bold">next</span> <span style="color:#080; font-weight:bold">if</span> file.match(<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">vendor/rails</span><span style="color:#710">"</span></span>)
    <span style="color:#080; font-weight:bold">begin</span>
      <span style="color:#036; font-weight:bold">YAML</span>.load_file(file)
    <span style="color:#080; font-weight:bold">rescue</span> =&gt; e
      puts <span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="background-color:#fff0f0"><span style="color:#710">#{</span>file<span style="color:#710">}</span></span><span style="color:#D20">:</span><span style="background-color:#fff0f0"><span style="color:#710">#{</span>(e.message.match(<span style="background-color:#fff0ff"><span style="color:#404">/</span><span style="color:#808">on line (</span><span style="color:#04D">\d</span><span style="color:#808">+)</span><span style="color:#404">/</span></span>)[<span style="color:#00D; font-weight:bold">1</span>] + <span style="background-color:#ffe0e0"><span style="color:#710">'</span><span style="color:#D20">:</span><span style="color:#710">'</span></span>) <span style="color:#080; font-weight:bold">rescue</span> <span style="color:#038; font-weight:bold">nil</span><span style="color:#710">}</span></span><span style="color:#D20"> </span><span style="background-color:#fff0f0"><span style="color:#710">#{</span>e.message<span style="color:#710">}</span></span><span style="color:#710">"</span></span>
    <span style="color:#080; font-weight:bold">end</span>
  <span style="color:#080; font-weight:bold">end</span>
<span style="color:#080; font-weight:bold">end</span></pre>
</div>
</div>
<p>And here’s what the output looks like:</p>
<div class="CodeRay">
<div class="code">
<pre>warren:tmp_project$ rake check_syntax
(in /Users/warren/tmp_project)
app/controllers/application.rb:37: syntax error, unexpected '='
app/views/people/home.html.erb:60: syntax error, unexpected '&lt;', expecting $end
vendor/plugins/will_paginate/test/fixtures/users.yml:13: syntax error on line 13, col 0: `dev_&lt;%= digit %&gt;:'</pre>
</div>
</div>
<p>This could probably be expanded to support lots of other types of files as well (css, javascripts, etc).</p>
<h2>Updates:</h2>
<ul>
<li>Exclude all files in vendor/rails (thanks szeryf)</li>
</ul>