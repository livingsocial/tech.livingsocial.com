---
layout: post
title: Permanent Link to Super fast IP to lat/lng in Rails
author: aaron
---
      
					<p>In building the <a href="http://blog.hungrymachine.com/2007/10/19/the-importance-of-eye-candy-and-no-not-the-kind-you-re-thinking">eye candy demo</a> for the Graphing Social conference, I needed a quick way to geo-locate users by IP address.  For Rails, <a href="http://geokit.rubyforge.org/">GeoKit</a> is an awesome plugin. It supports a list of providers, and overlays distance calculations, before_filter helpers, all sorts of good stuff.<br></p>
<p>It uses <a href="http://www.hostip.info/">hostip.info</a> to do IP to lat/lng, using their RESTful interface:</p>
<div class="CodeRay">
<div class="code">
<pre>http<span style="color:#A60">:/</span>/api.hostip.info/get_html.php?ip=<span style="color:#60E; font-weight:bold">12.215</span>.<span style="color:#60E; font-weight:bold">42.19</span>&amp;position=<span style="color:#038; font-weight:bold">true</span>
  <span style="color:#036; font-weight:bold">Country</span>: <span style="color:#036; font-weight:bold">UNITED</span> <span style="color:#036; font-weight:bold">STATES</span> (<span style="color:#036; font-weight:bold">US</span>)
  <span style="color:#036; font-weight:bold">City</span>: <span style="color:#036; font-weight:bold">Sugar</span> <span style="color:#036; font-weight:bold">Grove</span>, <span style="color:#036; font-weight:bold">IL</span>
  <span style="color:#036; font-weight:bold">Latitude</span>: <span style="color:#60E; font-weight:bold">41.7696</span>
  <span style="color:#036; font-weight:bold">Longitude</span>: <span style="color:#60E; font-weight:bold">-88.4588</span></pre>
</div>
</div>
<p><br><br>
This is great, but its just too darn slow to geolocate 12 users a second. All I needed was a FAST ip to lat/long lookup mechanism. Luckily, HostInfo provides the raw data. Hereâ€™s how I built super fast GeoLoc by IP method.<br><br><br><br>
Download, create a DB, and import the data.</p>
<div class="CodeRay">
<div class="code">
<pre>wget http<span style="color:#A60">:/</span>/hostip.ww.com/hostip_current.sql.gz
gunzip hostip_current.sql.gz
mysqladmin -uroot create hostip
mysql -uroot hostip &lt; hostip_current.sql</pre>
</div>
</div>
<p><br><br><br>
Create a simple HostIp class.  Note:  I need to dynamically build this query b/c the data is sharded across tables by the A class of the IP.</p>
<div class="CodeRay">
<div class="code">
<pre><span style="color:#080; font-weight:bold">class</span> <span style="color:#B06; font-weight:bold">Hostip</span> &lt; <span style="color:#036; font-weight:bold">ActiveRecord</span>::<span style="color:#036; font-weight:bold">Base</span>
  <span style="color:#080; font-weight:bold">def</span> <span style="color:#038; font-weight:bold">self</span>.geocode(ip)
    a,b,c,d = ip.split(<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">.</span><span style="color:#710">"</span></span>)
    <span style="color:#038; font-weight:bold">self</span>.set_table_name <span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">hostip.ip4_</span><span style="background-color:#fff0f0"><span style="color:#710">#{</span>a<span style="color:#710">}</span></span><span style="color:#710">"</span></span>
    ip = find(<span style="color:#A60">:first</span>, <span style="color:#A60">:select</span> =&gt; <span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">lat,lng</span><span style="color:#710">"</span></span>,
                <span style="color:#A60">:joins</span> =&gt; <span style="background-color:#fff0f0"><span style="color:#710">%Q{</span><span style="color:#D20">INNER JOIN hostip.cityByCountry
                               ON hostip.ip4_</span><span style="background-color:#fff0f0"><span style="color:#710">#{</span>a<span style="color:#710">}</span></span><span style="color:#D20">.city = hostip.cityByCountry.city
                               AND hostip.ip4_</span><span style="background-color:#fff0f0"><span style="color:#710">#{</span>a<span style="color:#710">}</span></span><span style="color:#D20">.country = hostip.cityByCountry.country</span><span style="color:#710">}</span></span>,
                <span style="color:#A60">:conditions</span> =&gt; [<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">b = ? and c = ?</span><span style="color:#710">"</span></span>, b,c])
    <span style="color:#080; font-weight:bold">if</span> ip
      [ip.lat, ip.lng]
    <span style="color:#080; font-weight:bold">else</span>
      [<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#710">"</span></span>,<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#710">"</span></span>]
    <span style="color:#080; font-weight:bold">end</span>
  <span style="color:#080; font-weight:bold">end</span>
<span style="color:#080; font-weight:bold">end</span> </pre>
</div>
</div>
<p><br><br></p>
<p>Usage</p>
<div class="CodeRay">
<div class="code">
<pre>&gt;&gt; <span style="color:#036; font-weight:bold">Hostip</span>.geocode(<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">4.2.2.2</span><span style="color:#710">"</span></span>)
=&gt; [<span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">39.944</span><span style="color:#710">"</span></span>, <span style="background-color:#fff0f0"><span style="color:#710">"</span><span style="color:#D20">-105.062</span><span style="color:#710">"</span></span>]</pre>
</div>
</div>
<p><br><br></p>
<p>Thats it!  Now you can geolocate by IP in your own datacenter.  <br><br>
Thanks again to the guys at HostIp for sharing this data!</p>
				